machine:
  java:
    version: oraclejdk8
  environment:
    GRADLE_OPTS: "-Xmx2g"
    _JAVA_OPTIONS: "-Xms256m -Xmx1536m"
    CIRCLE_JDK_VERSION: oraclejdk8
    JAVA7_HOME: "/usr/lib/jvm/java-7-openjdk-amd64"
    JAVA8_HOME: "/usr/lib/jvm/jdk1.8.0"
    TERM: "dumb"
    ADB_INSTALL_TIMEOUT: "10"
  post:
    # Turn off unneded services to free memory.
    - for service in {"apache2","beanstalkd","cassandra","couchbase-server","couchdb","docker","elasticsearch","memcached","mongodb","mysql","neo4j-service","postgresql","puppet","redis-server","riak","solr","sphinxsearch","zookeeper"}; do sudo service $service stop; done


dependencies:
  pre:
    - echo y | android update sdk --no-ui --all --filter tools,android-23,platform-tools,extra-android-m2repository,extra-android-support
    - echo y | android update sdk --no-ui --all --filter build-tools-23.0.2
  cache_directories:
    - ~/.android
  override:
    - ./gradlew dependencies
  post:
    - echo n | android create avd -n testing18 -f -t android-18


test:
  pre:
    - case $CIRCLE_NODE_INDEX in 0) echo "launching 22" && emulator -avd circleci-android22 -no-audio -no-window ;; 1) echo "launching 18" && emulator -avd testing18 -no-audio -no-window -no-boot-anim ;; esac:
         parallel: true
         background: true
  override:
    # Build tests classes in the background and run unit tests(since they are very quick).
    - ./gradlew :app:assembleDebugAndroidTest check -PdisablePreDex:
        parallel: true
    # Ensure that emulator booted
    - circle-android wait-for-boot:
        parallel: true
        background: true
    - sleep 30 # without it devices still are shown as offline
    # debug print
    - adb devices:
        parallel: true
    # unlocking the emulator screen
    - adb shell input keyevent 82:
        parallel: true
    - adb logcat -d:
        parallel: true
    # Run instrumented tests.
    - ./gradlew spoon -x lint --no-daemon -PdisablePreDex --stacktrace:
        #parallel: true
        timeout: 1800
  post:
    # copy the build outputs to artifacts
    - cp -r app/build/outputs $CIRCLE_ARTIFACTS
    # copy the test results to the test results directory.
    - cp -r app/build/reports $CIRCLE_TEST_REPORTS
    - cp -r app/build/spoon/* $CIRCLE_TEST_REPORTS/:
        parallel: true
    - adb logcat -d > $CIRCLE_ARTIFACTS/logcat_emulator.txt:
        parallel: true
